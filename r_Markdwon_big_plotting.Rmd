---
title: "Reindeer_RMarkdown"
author: "Ronja Seitz"
date: "2025-03-03"
output: html_document

params:
  point_data:
    label: "Input points:"
    value: "C:/Users/ronja/Downloads/faeces_sampling_2023_2024_all_data_continuously_updated.csv"
    input: file                # Default points file
  year:
    label: "Year"
    value: 2017
    input: slider
    min: 2010
    max: 2018
    step: 1
    sep: ""
    
---

# **Load Required Libraries**
```{r setup, message=FALSE, warning=FALSE}
library(terra)      # For raster data
library(sf)         # For vector data (points)
library(ggplot2)    # For static maps
library(leaflet)    # For interactive maps
library(leaflet.extras)  # For additional map controls      # For handling spatial data
library(dplyr)    # For data manipulation
library(rayshader) # to create shiny 2d and 3d maps
library(magick) # load images to add to shiny maps
```



```{r create leaflet map}
# Define WMTS URLs
svalbard_basemap_wmts <- "https://geodata.npolar.no/arcgis/rest/services/Basisdata/NP_Basiskart_Svalbard_WMTS_3857/MapServer/WMTS/tile/1.0.0/Basisdata_NP_Basiskart_Svalbard_WMTS_3857/default/default028mm/{z}/{y}/{x}.jpgpng"

svalbard_satellite_wmts <- "https://geodata.npolar.no/arcgis/rest/services/Basisdata/NP_Satellitt_Svalbard_WMTS_3857/MapServer/WMTS/tile/1.0.0/Basisdata_NP_Satellitt_Svalbard_WMTS_3857/default/default028mm/{z}/{y}/{x}.jpgpng"

# Create Leaflet map with multiple basemaps and overlays
topo_map <- leaflet() %>%
  setView(lng = 15, lat = 78, zoom = 5) %>%  # Center on Svalbard
  
  # Add basemap options
  addProviderTiles(providers$Esri.WorldImagery, group = "Esri Satellite") %>%
  addProviderTiles(providers$OpenStreetMap, group = "OpenStreetMap") %>%
  addProviderTiles(providers$CartoDB.Positron, group = "CartoDB Light") %>%
  
  # Add the Svalbard Basemap WMTS layer
  addWMSTiles(
    baseUrl = svalbard_basemap_wmts,
    layers = "Basisdata_NP_Basiskart_Svalbard_WMTS_3857",
    options = WMSTileOptions(format = "image/jpgpng", transparent = TRUE),
    group = "Svalbard Basemap"
  ) %>%
  
  # Add the Svalbard Satellite WMTS layer
  addWMSTiles(
    baseUrl = svalbard_satellite_wmts,
    layers = "Basisdata_NP_Satellitt_Svalbard_WMTS_3857",
    options = WMSTileOptions(format = "image/jpgpng", transparent = TRUE),
    group = "Svalbard Satellite"
  ) %>%
  
  # Add layer control to switch between base layers and overlays
  addLayersControl(
    baseGroups = c("Esri Satellite", "OpenStreetMap", "CartoDB Light"),
    overlayGroups = c("Svalbard Basemap", "Svalbard Satellite"),
    options = layersControlOptions(collapsed = FALSE)
  )

topo_map

```

```{r add points}
# Step 1: Read the CSV file into R
data <- read.csv(params$point_data)

# Remove rows with missing values in utm_easting or utm_northing
data_clean <- data %>%
  filter(!is.na(utm_easting) & !is.na(utm_northing))

# Step 2: Create an sf object with UTM coordinates (EPSG:25833)
data_sf <- st_as_sf(data_clean, coords = c("utm_easting", "utm_northing"), crs = 25833)

# Step 3: Reproject the coordinates to EPSG:3857 (Web Mercator)
data_projected <- st_transform(data_sf, crs = 4326)

# Step 4: Extract the longitude and latitude (in EPSG:3857) as numeric vectors
lng <- st_coordinates(data_projected)[, 1]
lat <- st_coordinates(data_projected)[, 2]


# Step 6: Add markers to the Leaflet map
for (i in 1:length(lng)) {
  reindeer_map <- topo_map %>%
    addCircleMarkers(lng = lng[i], lat = lat[i], radius = 3, color = "white", fill = TRUE, fillColor = "grey", fillOpacity = 0.7, opacity = 1)
}

# Output the updated map
reindeer_map
```

```{r create a basic 2d map and 3d map of Bjorndalen based on a DEM}
#l load all needed datasets
dem <- rast("/Users/ronja/Documents/EAGLE/Svalbard/larissa_sos/DEM_Bjorndalen.tif") # digital elevation model of bjorndalen (source: https://geodata.npolar.no/)

# Convert the cropped DEM to a matrix necessary for use with raysahder
bjorndalen <- raster_to_matrix(dem)

# Calculate a color for each point on the surface
bjorndalen_shade <- sphere_shade(bjorndalen, texture = "desert")
plot_map(bjorndalen_shade)
plot_3d(bjorndalen_shade, bjorndalen, zscale = 10, fov = 60, theta = 45, phi = 45)


```

```{r add a satellite picture published by the Norsk Polar Institute to the 3D map}
#load datasets
orthophoto <- image_read("/Users/ronja/Documents/EAGLE/Svalbard/larissa_sos/Ortophoto_Bjorndalen.tif") #load orthophoto of area (source: https://geodata.npolar.no/)

orthophoto <- orthophoto %>%
  image_resize(paste0(ncol(bjorndalen), "x", nrow(bjorndalen))) %>%
  image_data()

orthophoto_rgb <- drop(as.numeric(orthophoto))
bjorndalen_shade <- rayshader::add_overlay(bjorndalen_shade, orthophoto_rgb)

# plot 3d map with rgb overlay

plot_3d(bjorndalen_shade, bjorndalen, zscale = 10, fov = 60, theta = 45, phi = 45)
```

``` {r Plot points}
data_points <- vect("/Users/ronja/Documents/EAGLE/Svalbard/larissa_sos/BjorndalenReindeer_Points.gpkg")
# crop points to extent of dem
data_cropped <- crop(data_points, dem)

# Extract the longitude and latitude (in EPSG:3857) as numeric vectors
coords_x <- geom(data_cropped)[, c("x")]
coords_y <- geom(data_cropped)[, c("y")]

# Add 3D points without the 'extend' argument
render_points(lat = coords_y, long = coords_x,
              heightmap = bjorndalen,
              zscale = 10, color = "brown",
              extent = ext(dem),
              offset = 2,
              clear_previous = T,
              size = 5)

```


